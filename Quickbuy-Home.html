<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <title>QuickBuy - Products</title>
    <style>
       body {
    background-color: #f8f9fa;
    font-family: "Rubik", sans-serif;
}

.new-info {
    position: absolute;
    top: 10px;
    left: 10px;
    background-color: #000000;
    color: white;
    padding: 5px;
    border-radius: 5px;
    font-size: 12px;
}

.product-card {
    transition: transform 0.3s, box-shadow 0.3s;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position: relative;
    margin-bottom: 15px;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.card-img-top {
    height: 150px;
    object-fit: fill;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    border-bottom: 2px solid rgba(0, 0, 0, 0.1);
}

.new-label {
    position: absolute;
    top: 10px;
    left: 10px;
    background-color: #000000;
    color: white;
    padding: 5px;
    border-radius: 5px;
    font-size: 12px;
}

.category-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    padding: 10px 0;
}

.card-body {
    line-height: 0.5; /* Keep existing line height */
    font-size: 0.875rem;
}

.card-body h5 {
    text-align: left; /* Align product title to left */
    text-transform: lowercase; /* Make title lowercase */
}

.qty-container {
    margin-top: 0;
}

.price-container {
    margin-bottom: px;
}

.btn-primary {
    background-color: #007bff;
    border: none;
    border-radius: 25px;
    transition: background-color 0.3s, transform 0.3s; /* Added transform for hover effect */
    padding: 10px 0;
    margin-top: 10px;
}

.btn-primary:hover {
    background-color: #0056b3;
    transform: translateX(5px); /* Hover effect: move right */
}

.overflow-auto {
    overflow-x: hidden;
    white-space: nowrap;
}

.price-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.original-price {
    text-decoration: line-through;
    color: rgb(80, 80, 80);
    font-size: 0.875rem;
    line-height: 1; /* Adjusted line height */
}

.final-price {
    color: green;
    font-weight: bold;
    font-size: 0.875rem;
    margin-left: 10px;
    line-height: 1; /* Adjusted line height */
}

@media (max-width: 768px) {
    .bottom-nav {
        display: flex;
        justify-content: space-around;
        align-items: center;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #fff;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 10px 0;
    }
    .bottom-nav a {
        font-size: 18px;
        color: #000;
        text-align: center;
        flex-grow: 1;
        text-decoration: none;
    }
    .desktop-nav {
        display: none;
    }
    .mobile-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .nav-search {
        max-width: 60%;
    }
}

@media (min-width: 769px) {
    .bottom-nav {
        display: none;
    }
    .desktop-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #fff;
    }
    .nav-search {
        max-width: 500px;
    }
    .mobile-nav {
        display: none;
    }
}

.profile-img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: cover;
}

.desktop-nav, .mobile-nav {
    position: sticky;
    top: 0;
    z-index: 1000;
    background-color: #fff;
}

.bottom-nav {
    z-index: 1000;
}

footer {
    background-color: #000000;
}

a:hover {
    color: #007bff; /* Accent color */
    text-decoration: underline;
}

.spinner-container {
    position: fixed; /* Fixed positioning */
    top: 0; /* Align to the top */
    left: 0; /* Align to the left */
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    display: flex; /* Use flexbox */
    justify-content: center; /* Center horizontally */
    align-items: center; /* Center vertically */
    background-color: rgb(255, 255, 255); /* Optional: semi-transparent background */
    z-index: 1000; /* Ensure it appears on top */
    display: none; /* Initially hidden */
}

.loader {
    width: 20px;
    aspect-ratio: 1;
    background: #25b09b;
    box-shadow: 0 0 60px 15px #25b09b;
    transform: translate(-80px);
    clip-path: inset(0);
    animation:
        l4-1 0.5s ease-in-out infinite alternate,
        l4-2 1s ease-in-out infinite;
}

@keyframes l4-1 {
    100% { transform: translateX(80px); }
}

@keyframes l4-2 {
    33% { clip-path: inset(0 0 0 -100px); }
    50% { clip-path: inset(0 0 0 0); }
    83% { clip-path: inset(0 -100px 0 0); }
}


</style>
</head>
<body>
   
    
<!-- Mobile Navbar -->
<nav class="navbar mobile-nav">
    <a class="navbar-brand" href="#">QuickBuy</a>
    <form class="d-flex nav-search">
        <div class="input-group">
            <span class="input-group-text bg-white border-end-0">
                <i class="fas fa-search"></i>
            </span>
            <input class="form-control border-start-0" type="search" placeholder="Search for apples..." aria-label="Search" id="searchInput">
        </div>
    </form>
</nav>

<!-- Desktop Navbar -->
<nav class="navbar desktop-nav">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">QuickBuy</a>
        <form class="d-flex nav-search">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search"></i>
                </span>
                <input type="search" class="form-control border-start-0" placeholder="Search for apples..." aria-label="Search" id="searchInputDesktop">
            </div>
        </form>
        <div class="d-flex align-items-center">
            <a href="cart.html" class="me-3"><i class="fas fa-shopping-cart fa-2"></i></a>
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png" alt="Profile" class="profile-img" id="profileImage">
        </div>
    </div>
</nav>

<!-- Bottom Navbar for Mobile View -->
<nav class="bottom-nav">
    <a href="#"><i class="fas fa-home"></i><br>Home</a>
    <a href="#" id="profileLink"><img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"><br>You</a>
    <a href="#"><i class="fas fa-ellipsis-h"></i><br>More</a>
    <a href="cart.html"><i class="fas fa-shopping-cart fa-2"></i><br>Cart</a>
</nav>
<div id="spinner" class="spinner-container">
    <div class="loader"></div>
</div>

<div class="container mt-5">
    <h2 class="text-center mb-4"></h2>
    <div id="productCategories" class="row"></div>
</div>
<footer class="bg-light text-center text-lg-start mt-5">
    <div class="container p-4">
        <div class="row">
            <!-- Company Information -->
            <div class="col-lg-4 col-md-6 mb-4">
                <h5 class="text-uppercase fw-bold text-primary">QuickBuy</h5>
                <p class="text-muted">Your one-stop shop for all your grocery needs. Fast delivery, great prices, and a wide range of products.</p>
            </div>

            <!-- Quick Links -->
            <div class="col-lg-4 col-md-6 mb-4">
                <h5 class="text-uppercase fw-bold text-primary">Quick Links</h5>
                <ul class="list-unstyled">
                    <li><a href="#" class="text-muted d-inline-block mb-2">Home</a></li>
                    <li><a href="#" class="text-muted d-inline-block mb-2">Products</a></li>
                    <li><a href="#" class="text-muted d-inline-block mb-2">About Us</a></li>
                    <li><a href="#" class="text-muted d-inline-block mb-2">Contact</a></li>
                </ul>
            </div>

            <!-- Contact Information -->
            <div class="col-lg-4 col-md-6 mb-4">
                <h5 class="text-uppercase fw-bold text-primary">Contact Us</h5>
                <ul class="list-unstyled">
                    <li><i class="fas fa-envelope me-2"></i><a href="mailto:support@quickbuy.com" class="text-muted">support@quickbuy.com</a></li>
                    <li><i class="fas fa-phone me-2"></i><a href="tel:+1234567890" class="text-muted">+1 234 567 890</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="text-center p-3 bg-dark text-white">
        &copy; 2024 <span class="text-primary">QuickBuy</span>. All rights reserved.
    </div>
</footer>

<!-- FontAwesome CDN for Icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
    import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js"; 

    const firebaseConfig = {
        apiKey: "AIzaSyBjZDiWXkOclw7RmmU31822nPuj9px1hSA",
        authDomain: "quickbuy-29329.firebaseapp.com",
        projectId: "quickbuy-29329",
        storageBucket: "quickbuy-29329.appspot.com",
        messagingSenderId: "956510631625",
        appId: "1:956510631625:web:678411a2530ef065b97f18"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    let allProducts = {};
    let currentUserUid = null;
    let cartItems = {};
    const defaultProfilePicUrl = "https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png";

    onAuthStateChanged(auth, (user) => {
        if (user) {
            showSpinner();
            currentUserUid = user.uid;
            const userProfilePicUrl = user.photoURL || defaultProfilePicUrl;
            document.getElementById('profileImage').src = userProfilePicUrl;
            document.getElementById('profileLink').innerHTML = `<img src="${userProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;
            fetchCartItems().then(() => {
                hideSpinner();
                const storedCity = localStorage.getItem('userCity');
                if (storedCity) {
                    fetchProductsForCity(storedCity);
                } else {
                    showSpinner();
                    getUserLocation().then(location => {
                        hideSpinner();
                        const { latitude, longitude } = location;
                        getCityFromCoordinates(latitude, longitude).then(city => {
                            localStorage.setItem('userCity', city);
                            set(ref(database, `users/${currentUserUid}/location`), { city, latitude, longitude });
                            fetchProductsForLocation(latitude, longitude);
                        });
                    }).catch(error => {
                        hideSpinner();
                        console.error(error);
                    });
                }
            });
        } else {
            document.getElementById('profileImage').src = defaultProfilePicUrl;
            document.getElementById('profileLink').innerHTML = `<img src="${defaultProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;
        }
    });

    window.addEventListener('beforeunload', () => {
        localStorage.removeItem('userCity'); // Remove user location from local storage
        if (currentUserUid) {
            set(ref(database, `users/${currentUserUid}/location`), null).catch(error => {
                console.error("Error removing location from Firebase:", error);
            }); // Remove location from Firebase
        }
    });

    function getUserLocation() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                }, () => {
                    alert("Unable to retrieve your location. Please enable location services.");
                    reject("Unable to retrieve your location.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
                reject("Geolocation is not supported by this browser.");
            }
        });
    }

    async function getCityFromCoordinates(lat, lon) {
        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
        const data = await response.json();
        return data.city || data.locality || "Unknown City";
    }

    async function fetchProductsForLocation(lat, lon) {
        showSpinner();
        const productsRef = ref(database, 'products');
        onValue(productsRef, snapshot => {
            hideSpinner();
            const products = snapshot.val() || {};
            const filteredProducts = [];

            for (const key in products) {
                const productLat = parseFloat(products[key].latitude); // Ensure latitude is a number
                const productLon = parseFloat(products[key].longitude); // Ensure longitude is a number
                const distance = calculateDistance(lat, lon, productLat, productLon);
                if (distance <= 10) { // Only show products within 10 km
                    const product = {
                        id: key,
                        availability: products[key].availability,
                        category: products[key].category,
                        city: products[key].city,
                        finalPrice: products[key].finalPrice,
                        imageURL: products[key].imageURL,
                        listingPrice: products[key].listingPrice,
                        originalPrice: products[key].originalPrice,
                        productName: products[key].productName,
                        productType: products[key].productType,
                        qtyUnit: products[key].qtyUnit,
                        quantity: products[key].quantity,
                        stockAvailable: products[key].stockAvailable,
                        timestamp: products[key].timestamp,
                    };
                    filteredProducts.push(product);
                }
            }

            allProducts = groupProductsByCategory(filteredProducts);
            renderProducts(allProducts);
        });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the Earth in km
        const dLat = degreesToRadians(lat2 - lat1);
        const dLon = degreesToRadians(lon2 - lon1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(degreesToRadians(lat1)) * Math.cos(degreesToRadians(lat2)) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km
    }

    function degreesToRadians(degrees) {
        return degrees * (Math.PI / 180);
    }

    function groupProductsByCategory(products) {
        return products.reduce((acc, product) => {
            const category = product.category || 'Others';
            if (!acc[category]) {
                acc[category] = [];
            }
            acc[category].push(product);
            return acc;
        }, {});
    }

    async function fetchCartItems() {
        const localCart = JSON.parse(localStorage.getItem(`cart_${currentUserUid}`)) || {};
        if (Object.keys(localCart).length > 0) {
            cartItems = localCart;
            console.log("Loaded cart from local storage:", cartItems);
        } else {
            const cartRef = ref(database, `carts/${currentUserUid}`);
            const snapshot = await get(cartRef);
            if (snapshot.exists()) {
                cartItems = snapshot.val();
            } else {
                cartItems = {};
            }
        }
        storeCartInLocalStorage(cartItems);
    }

    function storeCartInLocalStorage(cart) {
        localStorage.setItem(`cart_${currentUserUid}`, JSON.stringify(cart));
        console.log("Stored cart in local storage.");
    }

    function renderProducts(products) {
        const categoriesContainer = document.getElementById('productCategories');
        categoriesContainer.innerHTML = '';

        const currentTime = new Date().getTime();

        for (const category in products) {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'col-12 mb-4';

            const categoryTitle = document.createElement('h4');
            categoryTitle.className = 'text-left mb-4';
            categoryTitle.textContent = category;
            categoryDiv.appendChild(categoryTitle);

            const productRow = document.createElement('div');
            productRow.className = 'overflow-auto d-flex gap-3';

            products[category].forEach(product => {
                const productCol = document.createElement('div');
                productCol.className = 'col-auto';

                const productCard = document.createElement('div');
                productCard.className = 'card product-card';
                productCard.style.width = '200px';

                const productImage = document.createElement('img');
                productImage.src = product.imageURL;
                productImage.className = 'card-img-top';
                productCard.appendChild(productImage);

                const productBody = document.createElement('div');
                productBody.className = 'card-body text-left';

                const productName = document.createElement('h5');
                productName.className = 'card-title';
                productName.textContent = product.productName;
                productBody.appendChild(productName);

                const productLabel = document.createElement('span');
                productLabel.className = 'new-info mb-2';
                productLabel.textContent = product.productType;
                productBody.appendChild(productLabel);

                const productTimestamp = new Date(product.timestamp).getTime();
                const fiveHoursInMillis = 5 * 60 * 60 * 1000;

                const timeDiff = currentTime - productTimestamp;
                if (timeDiff <= fiveHoursInMillis) {
                    const timeLabel = document.createElement('span');
                    timeLabel.className = 'badge bg-warning mb-2';
                    timeLabel.textContent = 'Available for 5 hrs only';

                    setTimeout(() => {
                        timeLabel.remove();
                    }, fiveHoursInMillis - timeDiff);
                }

                const priceContainer = document.createElement('div');
                priceContainer.className = 'price-container mb-2';

                const originalPrice = document.createElement('p');
                originalPrice.className = 'original-price';
                originalPrice.textContent = `MRP: ₹${product.originalPrice}`;

                const finalPrice = document.createElement('p');
                finalPrice.className = 'final-price';
                finalPrice.textContent = `Price: ₹${product.finalPrice}`;

                priceContainer.appendChild(originalPrice);
                priceContainer.appendChild(finalPrice);
                productBody.appendChild(priceContainer);

                const qtyInfo = document.createElement('p');
                qtyInfo.className = 'qty-info';
                qtyInfo.textContent = `${product.quantity} ${product.qtyUnit}`; 
                productBody.appendChild(qtyInfo);

                const qtyContainer = document.createElement('div');
                qtyContainer.className = 'd-flex align-items-center qty-container';

                const qtyLabel = document.createElement('span');
                qtyLabel.textContent = 'QTY:';
                qtyLabel.className = 'me-2';

                const qtySelect = document.createElement('select');
                qtySelect.className = 'form-select w-auto';
                qtySelect.style.width = "80px";

                const maxQty = Math.min(5, product.stockAvailable);
                for (let i = 1; i <= maxQty; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    qtySelect.appendChild(option);
                }

                qtyContainer.appendChild(qtyLabel);
                qtyContainer.appendChild(qtySelect);
                productBody.appendChild(qtyContainer);

                const addToCartButton = document.createElement('button');
                addToCartButton.className = 'btn btn-primary w-100';

                if (cartItems[product.id]) {
                    addToCartButton.innerHTML = '<i class="fa fa-check"></i>';
                    addToCartButton.disabled = true;
                } else {
                    addToCartButton.textContent = 'Add to Cart';
                    addToCartButton.addEventListener('click', () => {
                        const quantity = qtySelect.value;
                        addToCart(product, quantity);
                    });
                }

                productBody.appendChild(addToCartButton);
                productCard.appendChild(productBody);
                productCol.appendChild(productCard);
                productRow.appendChild(productCol);
            });

            categoryDiv.appendChild(productRow);
            categoriesContainer.appendChild(categoryDiv);
        }
    }

    async function addToCart(product, quantity) {
        const cartRef = ref(database, `carts/${currentUserUid}/${product.id}`);
        const cartItem = {
            productName: product.productName,
            finalPrice: product.finalPrice,
            quantity: parseInt(quantity),
            totalPrice: (product.finalPrice * quantity).toFixed(2),
            imageURL: product.imageURL,
            productType: product.productType,
            originalPrice: product.originalPrice,
            qtyUnit: product.qtyUnit,
            availableQuantity: product.quantity
        };

        await set(cartRef, cartItem);
        console.log('Product added to cart:', cartItem);
        alert(`${product.productName} added to cart!`);

        cartItems[product.id] = cartItem; 
        storeCartInLocalStorage(cartItems); 
        renderProducts(allProducts); 
    }

    function filterProducts() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase() || 
                           document.getElementById('searchInputDesktop').value.toLowerCase();
        const filteredProducts = {};

        for (const category in allProducts) {
            const productsInCategory = allProducts[category].filter(product =>
                product.productName.toLowerCase().includes(searchTerm)
            );

            if (productsInCategory.length > 0) {
                filteredProducts[category] = productsInCategory;
            }
        }

        renderProducts(filteredProducts);
    }

    document.getElementById('searchInput').addEventListener('input', filterProducts);
    document.getElementById('searchInputDesktop').addEventListener('input', filterProducts);

    function showSpinner() {
        document.getElementById('spinner').style.display = 'flex';
    }

    function hideSpinner() {
        document.getElementById('spinner').style.display = 'none';
    }
</script>

</body>
</html>
