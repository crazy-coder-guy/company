<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300..900;1,300..900&display=swap" rel="stylesheet">
    <title>QuickBuy - Products</title>
    <style>
       body {
    background-color: #f8f9fa;
    font-family: "Rubik", sans-serif;
}
.new-info {
    position: absolute;
    top: 0px;
    left: 0px;
    background-color: #347928;
    color: white;
    padding: 5px;
    border-radius: 2px; /* Unified border-radius property */
    border: none; /* Changed from groove to none */
    font-size: 15px;
    text-align: left; /* Align text to the left */
    border-top-left-radius: 12px;
}


.product-card {
    transition: transform 0.3s, box-shadow 0.3s;
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    position: relative;
    margin-bottom: 15px;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
}

.card-img-top {
    height: 150px !important; /* Force the height to 80px */
    object-fit: contain;
    border-top-left-radius: 6px; /* Smaller radius */
    border-top-right-radius: 6px; /* Smaller radius */
    border-bottom: 1px solid rgba(0, 0, 0, 0.1); /* Reduced border thickness */
}

.category-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    padding: 10px 0;
}

.card-body {
    line-height: 1; /* Keep existing line height */
    font-size: 0.875rem;
}

.card-body h5 {
    text-align: left; /* Align product title to left */
    text-transform: uppercase; /* Make title lowercase */
    font-size: 1rem;
}

.qty-container {
    margin-top: 0;
}

.btn-primary {
    background-color: #347928;
    border: none;
    border-radius: 25px;
    transition: background-color 0.3s, transform 0.3s; /* Added transform for hover effect */
    padding: 10px 0;
    margin-top: 10px;
}

.btn.add {
  background-color: #347928;
    color: #ffffff; /* Text color */
    border: none; /* Remove default border */
    border-radius: 4px; /* Optional: rounded corners */
    padding: 10px; /* Optional: padding for better spacing */
    font-size: 16px; /* Optional: font size */
}

.overflow-auto {
    overflow-x: hidden;
    white-space: nowrap;
}
.price-container {
    display: flex;
    align-items: center; /* Center items vertically */
    gap: 10px; /* Space between elements */
    margin-bottom: 0; /* Ensure no extra margin at the bottom */
}

.discount-amount {
    color: green; /* Green color for discount */
    font-size: 0.875rem; /* Adjust font size */
    line-height: 1; /* Ensure consistent line height */
}

.original-price {
    text-decoration: line-through;
    color: rgb(80, 80, 80);
    font-size: 0.875rem; /* Adjust font size */
    line-height: 1; /* Ensure consistent line height */
}

.final-price {
    color: green; /* Green color for final price */
    font-weight: bold;
    font-size: 0.875rem; /* Adjust font size */
    line-height: 1; /* Ensure consistent line height */
}

@media (max-width: 768px) {
    .bottom-nav {
        display: flex;
        justify-content: space-around;
        align-items: center;
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: #fff;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
        padding: 10px 0;
    }
    .bottom-nav a {
        font-size: 18px;
        color: #000;
        text-align: center;
        flex-grow: 1;
        text-decoration: none;
    }
    .desktop-nav {
        display: none;
    }
    .mobile-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .nav-search {
        max-width: 100%;
    }
}

@media (min-width: 769px) {
    .bottom-nav {
        display: none;
    }
    .desktop-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: #fff;
    }
    .nav-search {
        max-width: 500px;
    }
    .mobile-nav {
        display: none;
    }
    .delivery-info {
    margin-bottom: 10px;
}

}

.profile-img {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    object-fit: contain;
}

.desktop-nav, .mobile-nav {
    position: sticky;
    top: 0;
    z-index: 1000;
    background-color: #fff;
}

.bottom-nav {
    z-index: 1000;
}

footer {
    background-color: #000000;
}

a:hover {
    color: #007bff; /* Accent color */
    text-decoration: underline;
}
.qty-container {
    display: flex;
    align-items: center; /* Center items vertically */
}

.qty-container {
    display: flex;
    align-items: center; /* Center items vertically */
}

.qty-display-container {
    margin: 0 10px; /* Add margin for spacing */
    text-align: center; /* Center the text within the span */
    background-color: rgb(255, 255, 255); /* White background for the quantity display */
    padding: 1px; /* Add some padding for better spacing */
    border-radius: 4px; /* Optional: rounded corners */
}

.btn {
    width: 30px; /* Fixed width for buttons */
    margin: 5px; /* No margin between buttons */
    background-color: green; /* Green background for buttons */
    color: white; /* White text for buttons */
    border: none; /* Remove default border */
    border-radius: 4px; /* Optional: rounded corners */
}

.btn:hover {
    background-color: darkgreen; /* Darker green on hover */
}
.spinner-container {
    position: fixed; /* Fixed positioning */
    top: 0; /* Align to the top */
    left: 0; /* Align to the left */
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    display: flex; /* Use flexbox */
    justify-content: center; /* Center horizontally */
    align-items: center; /* Center vertically */
    background-color: rgb(255, 255, 255); /* Optional: semi-transparent background */
    z-index: 1000; /* Ensure it appears on top */
    display: none; /* Initially hidden */
}

.loader {
    width: 20px;
    aspect-ratio: 1;
    background: #25b09b;
    box-shadow: 0 0 60px 15px #25b09b;
    transform: translate(-80px);
    clip-path: inset(0);
    animation:
        l4-1 0.5s ease-in-out infinite alternate,
        l4-2 1s ease-in-out infinite;
}

@keyframes l4-1 {
    100% { transform: translateX(80px); }
}

@keyframes l4-2 {
    33% { clip-path: inset(0 0 0 -100px); }
    50% { clip-path: inset(0 0 0 0); }
    83% { clip-path: inset(0 -100px 0 0); }
}.category-link {
    text-decoration: none; /* Remove underline */
    color: inherit; /* Use inherited color for modern look */
    display: block; /* Make the link block level to cover the entire area */
    transition: transform 0.3s ease, box-shadow 0.3s ease; /* Smooth transitions for transform and shadow */
}

.category {
    position: relative; /* Position relative for absolute children */
    overflow: hidden; /* Hide overflow */
    padding: 20px; /* Add some padding */
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); /* Optional shadow for depth */
    transition: box-shadow 0.3s ease; /* Smooth shadow transition */
}

.category:hover {
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.2); /* Increase shadow on hover */
    transform: translateY(-5px); /* Lift the card slightly */
}

.category-link:hover .category-name {
    color: #372847; /* Change color on hover */
}

.category-name {
    font-weight: 600; /* Bold text for modern appearance */
    font-size: 16px; /* Adjust font size as needed */
    margin-top: 8px; /* Space between image and text */
    transition: color 0.3s ease; /* Smooth color transition */
}

/* Optional: Change image opacity on hover */
.category-link img {
    transition: opacity 0.3s ease; /* Smooth transition for image */
}

.category-link:hover img {
    opacity: 0.8; /* Slightly fade the image on hover */
}

.offer-slider {
    display: flex;
    overflow: hidden;
    position: relative;
}

.offer-card {
    min-width: 100%; /* Full width in mobile view */
    transition: transform 0.5s ease;
    text-align: center;
}

.offer-card img {
    width: 100%;
    height: 300px; /* Adjust as needed for height */
    object-fit: contain;
}

.dots-container {
    position: absolute;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
}

.dot {
    height: 10px;
    width: 10px;
    margin: 0 5px;
    background-color: #bbb;
    border-radius: 50%;
    display: inline-block;
    cursor: pointer;
}

.active {
    background-color: #717171;
}

/* Responsive styles */
@media (min-width: 768px) {
    .offer-card {
        min-width: 50%; /* Show 2 cards at a time */
    }
}

@media (max-width: 768px) {
    .offer-card {
        min-width: 100%; /* Show 1 card at a time */
    }
}

.category-img {
    height: 120px; /* Fixed height */
    width: 100%; /* Full width */
    object-fit: cover; /* Fill the space while maintaining aspect ratio */
    border-radius: 6px; /* Optional: rounded corners */
}
.category-video {
    width: 100%; /* Make the video take the full width of its parent */
    height: 120px; /* Set a fixed height to match your images */
    object-fit: cover; /* Ensure the video covers the area without distortion */
    border-radius: 12px; /* Optional: for rounded corners */
}

</style>
</head>
<body>
   
<!-- Mobile Navbar -->
<nav class="navbar mobile-nav">
    <a class="navbar-brand" href="#">QuickBuy</a>
    <div class="nav-search-container">
        <form id="searchForm" class="d-flex nav-search">
            <div class="input-group">
                <span class="input-group-text bg-transparent border-end-0 search-icon">
                    <i class="fas fa-search"></i>
                </span>
                <input type="text" id="searchInput" class="form-control modern-search" placeholder="Search for products..." />
            </div>
        </form>
    </div>
</nav>

<!-- Desktop Navbar -->
<nav class="navbar desktop-nav">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">QuickBuy</a>
        <form class="d-flex nav-search">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0">
                    <i class="fas fa-search"></i>
                </span>
                <input type="search" class="form-control border-start-0" placeholder="Search for apples..." aria-label="Search" id="searchInputDesktop">
            </div>
        </form>
        <div class="d-flex align-items-center">
            <a href="cart.html" class="me-3"><i class="fas fa-shopping-cart fa-2"></i></a>
            <img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png" alt="Profile" class="profile-img" id="profileImage">
        </div>
    </div>
</nav>

<!-- Bottom Navbar for Mobile View -->
<nav class="bottom-nav">
    <a href="#"><i class="fas fa-home"></i><br>Home</a>
    <a href="User-Profile.html" id="profileLink"><img src="https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"><br>You</a>
    <a href="#"><i class="fas fa-ellipsis-h"></i><br>More</a>
    <a href="cart.html"><i class="fas fa-shopping-cart fa-2"></i><br>Cart</a>
</nav>
<div id="spinner" class="spinner-container">
    <div class="loader"></div>
</div>

<div class="category mt-1">
    <h2 class="text-center mb-4">Categories</h2>
    <div class="row g-1">
        <div class="col-4 mb-2 custom-margin">
            <a href="#SnacksandSweets" class="category-link" onclick="scrollToCategory('SnacksandSweets'); return false;">
                <img src="https://media.istockphoto.com/id/1263686908/photo/mixed-salty-snack-flat-lay-table-scene-on-a-wood-background.jpg?s=612x612&w=0&k=20&c=rCZ-gpvz--NpeNA0cYGCyJj3EK0kFUSkvdsow9u4I3o=" class="img-fluid category-img" alt="Snacks and Sweets" />
                <div class="text-center category-name">Snacks and Sweets</div>
            </a>
        </div>
        <div class="col-4 mb-2 custom-margin">
            <a href="#Bakery" class="category-link" onclick="scrollToCategory('Bakery'); return false;">
                <video class="img-fluid category-video" muted loop playsinline autoplay>
                    <source src="src/Iklan Sweet Talk Bakery - Product Commercial Video.mp4" type="video/mp4">
                    Your browser does not support the video tag.
                </video>
                <div class="text-center category-name">Bakery</div>
            </a>
        </div>
        
        <div class="col-4 mb-2 custom-margin">
            <a href="#PersonalCare" class="category-link" onclick="scrollToCategory('PersonalCare'); return false;">
                <img src="https://t4.ftcdn.net/jpg/01/68/51/55/360_F_168515550_AYObBKUuUS3k0fleEsBI0yxVGVYOm5nm.jpg" class="img-fluid category-img" alt="Personal Care" />
                <div class="text-center category-name">Personal Care</div>
            </a>
        </div>
        <div class="col-4 mb-2 custom-margin">
            <a href="#DairyProducts" class="category-link" onclick="scrollToCategory('DairyProducts'); return false;">
                <img src="https://d1n5l80rwxz6pi.cloudfront.net/general/blog/importance-of-dairy-products.jpg" class="img-fluid category-img" alt="Dairy Products" />
                <div class="text-center category-name">Dairy Products</div>
            </a>
        </div>
        <div class="col-4 mb-2 custom-margin">
            <a href="#Beverages" class="category-link" onclick="scrollToCategory('Beverages'); return false;">
                <img src="https://media.istockphoto.com/id/1062831310/photo/pour-soft-drink-in-glass-with-ice-splash-on-dark-background.jpg?s=612x612&w=0&k=20&c=XlLTcFQ0FqcTWRa9QniHgpjlkdFrOJGJFGm5jg_TAAw=" class="img-fluid category-img" alt="Beverages" />
                <div class="text-center category-name">Beverages</div>
            </a>
        </div>
        <div class="col-4 mb-2 custom-margin">
            <a href="#HouseholdEssentials" class="category-link" onclick="scrollToCategory('HouseholdEssentials'); return false;">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS4Kgb0vfeGzM8xOkMdyrOhHLaxkomKUYz8Yw&s" class="img-fluid category-img" alt="Household Essentials" />
                <div class="text-center category-name">Household Essentials</div>
            </a>
        </div>
    </div>
</div>

<div class="offer-slider mt-1">
    <div class="offer-card">
        <img src="https://cdn.grabon.in/gograbon/images/web-images/uploads/1618548899692/groceries-offers.jpg" alt="Offer 1" />
    </div>
    <div class="offer-card">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQyNOiIVNNjMQTjIsSdkP3pLj8ci1t-TDJFFg&s" alt="Offer 2" />
    </div>
    <div class="offer-card">
        <img src="https://assets.indiadesire.com/images/jiomart%20grocery%20shopping.jpg" alt="Offer 3" />
    </div>
    <div class="offer-card">
        <img src="https://cdn.grabon.in/gograbon/images/merchant/1572609154076.png" alt="Offer 4" />
    </div>
    <div class="dots-container"></div>
</div>

<div class="container mt-5">
    <h2 class="text-center mb-4"></h2>
    <div id="productCategories" class="row"></div>
</div>
<div class="ad-video-container">
    <video class="img-fluid ad-video" muted loop playsinline autoplay>
        <source src="src/Pringles’ Commercial _ Stop Motion Animation (HD).mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>
<footer class="bg-light text-center text-lg-start mt-5">
    <div class="container p-4">
        <div class="row">
            <!-- Company Information -->
            <div class="col-lg-4 col-md-6 mb-4">
                <h5 class="text-uppercase fw-bold text-primary">QuickBuy</h5>
                <p class="text-muted">Your one-stop shop for all your grocery needs. Fast delivery, great prices, and a wide range of products.</p>
            </div>

            <!-- Quick Links -->
            <div class="col-lg-4 col-md-6 mb-4">
                <h5 class="text-uppercase fw-bold text-primary">Quick Links</h5>
                <ul class="list-unstyled">
                    <li><a href="#" class="text-muted d-inline-block mb-2">Home</a></li>
                    <li><a href="#" class="text-muted d-inline-block mb-2">Products</a></li>
                    <li><a href="#" class="text-muted d-inline-block mb-2">About Us</a></li>
                    <li><a href="#" class="text-muted d-inline-block mb-2">Contact</a></li>
                </ul>
            </div>

            <!-- Contact Information -->
            <div class="col-lg-4 col-md-6 mb-4">
                <h5 class="text-uppercase fw-bold text-primary">Contact Us</h5>
                <ul class="list-unstyled">
                    <li><i class="fas fa-envelope me-2"></i><a href="mailto:support@quickbuy.com" class="text-muted">support@quickbuy.com</a></li>
                    <li><i class="fas fa-phone me-2"></i><a href="tel:+1234567890" class="text-muted">+1 234 567 890</a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Bottom Bar -->
    <div class="text-center p-3 bg-dark text-white">
        &copy; 2024 <span class="text-primary">QuickBuy</span>. All rights reserved.
    </div>
</footer>

<!-- FontAwesome CDN for Icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
    import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-auth.js"; 

    const firebaseConfig = {
        apiKey: "AIzaSyBjZDiWXkOclw7RmmU31822nPuj9px1hSA",
        authDomain: "quickbuy-29329.firebaseapp.com",
        projectId: "quickbuy-29329",
        storageBucket: "quickbuy-29329.appspot.com",
        messagingSenderId: "956510631625",
        appId: "1:956510631625:web:678411a2530ef065b97f18"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);

    let allProducts = {};
    let currentUserUid = null;
    let cartItems = {};
    const defaultProfilePicUrl = "https://upload.wikimedia.org/wikipedia/commons/9/99/Sample_User_Icon.png";

    onAuthStateChanged(auth, async (user) => {
    showSpinner();
    if (user) {
        currentUserUid = user.uid;
        
        // Fetch user data from Firebase
        const userSnapshot = await get(ref(database, `users/${currentUserUid}`));
        
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            // Use user photo from Firebase, if it doesn't exist, fall back to Gmail profile
            const userProfilePicUrl = userData.photo || user.photoURL || 'path/to/gmail_profile_logo.png'; // Replace with actual path to Gmail logo

            // Update the profile image
            document.getElementById('profileImage').src = userProfilePicUrl;
            document.getElementById('profileLink').innerHTML = `<img src="${userProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;

            // Update local storage if the Firebase photo differs from the user's photo
            if (userData.photo && userData.photo !== user.photoURL) {
                localStorage.setItem('userProfilePic', userData.photo);
            }
        } else {
            // Fallback if no user data found
            const defaultProfilePicUrl = 'path/to/gmail_profile_logo.png'; // Replace with actual path to Gmail logo
            document.getElementById('profileImage').src = defaultProfilePicUrl;
            document.getElementById('profileLink').innerHTML = `<img src="${defaultProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;
        }

        await fetchCartItems();
        hideSpinner();
        
        const storedCity = localStorage.getItem('userCity');
        if (storedCity) {
            fetchProductsForCity(storedCity);
        } else {
            showSpinner();
            getUserLocation().then(location => {
                hideSpinner();
                const { latitude, longitude } = location;
                getCityFromCoordinates(latitude, longitude).then(city => {
                    localStorage.setItem('userCity', city);
                    set(ref(database, `users/${currentUserUid}/location`), { city, latitude, longitude });
                    fetchProductsForLocation(latitude, longitude);
                });
            }).catch(error => {
                hideSpinner();
                console.error(error);
            });
        }
    } else {
        // User is not logged in
        const userSnapshot = await get(ref(database, `users/${currentUserUid}`));
        
        if (userSnapshot.exists()) {
            const userData = userSnapshot.val();
            const userProfilePicUrl = userData.photo || 'path/to/gmail_profile_logo.png'; // Replace with actual path to Gmail logo

            document.getElementById('profileImage').src = userProfilePicUrl;
            document.getElementById('profileLink').innerHTML = `<img src="${userProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;
        } else {
            const defaultProfilePicUrl = 'path/to/gmail_profile_logo.png'; // Replace with actual path to Gmail logo
            document.getElementById('profileImage').src = defaultProfilePicUrl;
            document.getElementById('profileLink').innerHTML = `<img src="${defaultProfilePicUrl}" alt="Profile" class="profile-img" style="width: 24px; height: 24px;"> <br> You`;
        }
    }
});

    window.addEventListener('beforeunload', () => {
        localStorage.removeItem('userCity'); // Remove user location from local storage
        if (currentUserUid) {
            set(ref(database, `users/${currentUserUid}/location`), null).catch(error => {
                console.error("Error removing location from Firebase:", error);
            }); // Remove location from Firebase
        }
    });

    function getUserLocation() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    });
                }, () => {
                    alert("Unable to retrieve your location. Please enable location services.");
                    reject("Unable to retrieve your location.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
                reject("Geolocation is not supported by this browser.");
            }
        });
     }

    async function getCityFromCoordinates(lat, lon) {
        const response = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=en`);
        const data = await response.json();
        return data.city || data.locality || "Unknown City";
    }

    async function fetchProductsForLocation(lat, lon) {
        showSpinner();
        const productsRef = ref(database, 'products');
        onValue(productsRef, snapshot => {
            hideSpinner();
            const products = snapshot.val() || {};
            const filteredProducts = [];

            for (const key in products) {
                const productLat = parseFloat(products[key].latitude); // Ensure latitude is a number
                const productLon = parseFloat(products[key].longitude); // Ensure longitude is a number
                const distance = calculateDistance(lat, lon, productLat, productLon);
                if (distance <= 10) { // Only show products within 10 km
                    const product = {
                        id: key,
                        availability: products[key].availability,
                        category: products[key].category,
                        city: products[key].city,
                        finalPrice: products[key].finalPrice,
                        imageURL: products[key].imageURL,
                        listingPrice: products[key].listingPrice,
                        originalPrice: products[key].originalPrice,
                        productName: products[key].productName,
                        productType: products[key].productType,
                        qtyUnit: products[key].qtyUnit,
                        quantity: products[key].quantity,
                        stockAvailable: products[key].stockAvailable,
                        timestamp: products[key].timestamp,
                    };
                    filteredProducts.push(product);
                }
            }

            allProducts = groupProductsByCategory(filteredProducts);
            renderProducts(allProducts);
        });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radius of the Earth in km
        const dLat = degreesToRadians(lat2 - lat1);
        const dLon = degreesToRadians(lon2 - lon1);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(degreesToRadians(lat1)) * Math.cos(degreesToRadians(lat2)) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Distance in km
    }

    function degreesToRadians(degrees) {
        return degrees * (Math.PI / 180);
    }

    function groupProductsByCategory(products) {
        return products.reduce((acc, product) => {
            const category = product.category || 'Others';
            if (!acc[category]) {
                acc[category] = [];
            }
            acc[category].push(product);
            return acc;
        }, {});
    }

    async function fetchCartItems() {
        const localCart = JSON.parse(localStorage.getItem(`cart_${currentUserUid}`)) || {};
        if (Object.keys(localCart).length > 0) {
            cartItems = localCart;
            console.log("Loaded cart from local storage:", cartItems);
        } else {
            const cartRef = ref(database, `carts/${currentUserUid}`);
            const snapshot = await get(cartRef);
            if (snapshot.exists()) {
                cartItems = snapshot.val();
            } else {
                cartItems = {};
            }
        }
        storeCartInLocalStorage(cartItems);
    }

    function storeCartInLocalStorage(cart) {
        localStorage.setItem(`cart_${currentUserUid}`, JSON.stringify(cart));
        console.log("Stored cart in local storage.");
    }

    function renderProducts(products) {
    const categoriesContainer = document.getElementById('productCategories');
    categoriesContainer.innerHTML = ''; // Clear previous content

    const currentTime = new Date().getTime();

    for (const category in products) {
        // Create a category container
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'col-12 mb-4';

        // Create a category section heading
        const categoryTitle = document.createElement('h4');
        categoryTitle.className = 'text-left mb-4';
        categoryTitle.textContent = category;

        // Assign an ID to the category title for smooth scrolling
        categoryTitle.id = category.replace(/\s+/g, ''); // Remove spaces for the ID

        categoryDiv.appendChild(categoryTitle);

        // Create a product row for the current category
        const productRow = document.createElement('div');
        productRow.className = 'd-flex overflow-auto gap-3'; // Flexbox for horizontal scrolling

        products[category].forEach(product => {
            const productCol = document.createElement('div');
            productCol.className = 'col-auto'; // Make sure columns are auto-sized

            const productCard = document.createElement('div');
            productCard.className = 'card product-card';
            productCard.style.width = '200px'; // Fixed width for cards

            const productImage = document.createElement('img');
                productImage.src = product.imageURL;
                productImage.className = 'card-img-top';
                productCard.appendChild(productImage);

            const productBody = document.createElement('div');
            productBody.className = 'card-body text-left';

            const productName = document.createElement('h5');
            productName.className = 'card-title';
            productName.textContent = product.productName;
            productBody.appendChild(productName);

            const productLabel = document.createElement('span');
            productLabel.className = 'new-info mb-2';
            productLabel.textContent = product.productType;

            const productTimestamp = new Date(product.timestamp).getTime();
            const oneMinuteInMillis = 1 * 60 * 1000; // 1 minute in milliseconds

            const timeDiff = currentTime - productTimestamp;

            // Show label only if product was listed within the last minute
            if (timeDiff < oneMinuteInMillis) {
                productBody.appendChild(productLabel);

                // Set a timeout to remove the product label after 1 minute
                setTimeout(() => {
                    productLabel.remove();
                }, oneMinuteInMillis - timeDiff); // Adjust timeout based on remaining time
            }

            const priceContainer = document.createElement('div');
            priceContainer.className = 'price-container mb-2';

            // Calculate discount percentage
            const originalPrice = parseFloat(product.originalPrice);
            const finalPrice = parseFloat(product.finalPrice);
            const discountAmount = originalPrice - finalPrice;

            const discountPercentage = Math.floor((originalPrice - finalPrice) );


            const discountElement = document.createElement('span');
            discountElement.className = 'discount-amount text-success';
            discountElement.innerHTML = `<i class="fa-solid fa-arrow-up fa-fade"></i> ${discountPercentage}%`;

            const originalPriceElement = document.createElement('span');
            originalPriceElement.className = 'original-price';
            originalPriceElement.innerHTML = `₹${originalPrice.toFixed(2)}`;

            const finalPriceElement = document.createElement('span');
            finalPriceElement.className = 'final-price';
            finalPriceElement.innerHTML = `₹${finalPrice.toFixed(2)}`;

            priceContainer.appendChild(discountElement);
            priceContainer.appendChild(originalPriceElement);
            priceContainer.appendChild(finalPriceElement);
            productBody.appendChild(priceContainer);

            const qtyInfo = document.createElement('p');
            qtyInfo.className = 'qty-info';
            qtyInfo.textContent = `${product.quantity} ${product.qtyUnit}`; 
            productBody.appendChild(qtyInfo);

            // Quantity buttons
            const qtyContainer = document.createElement('div');
            qtyContainer.className = 'd-flex align-items-center qty-container mt-2';

            const qtyLabel = document.createElement('span');
            qtyLabel.textContent = 'QTY:';
            qtyLabel.className = 'me-2';

            const minusButton = document.createElement('button');
            minusButton.textContent = '-';
            minusButton.className = 'btn btn-secondary btn-sm';
            minusButton.onclick = () => {
                let currentQty = parseInt(qtyDisplay.textContent);
                if (currentQty > 1) { // Prevent going below 1
                    currentQty--;
                    qtyDisplay.textContent = currentQty;
                }
            };

            const qtyDisplay = document.createElement('span');
            qtyDisplay.textContent = '1'; // Start with 1 by default
            qtyDisplay.className = 'qty-display-container me-2';

            const plusButton = document.createElement('button');
            plusButton.textContent = '+';
            plusButton.className = 'btn btn-secondary btn-sm';
            plusButton.onclick = () => {
                let currentQty = parseInt(qtyDisplay.textContent);
                const maxQty = Math.min(5, product.stockAvailable);
                if (currentQty < maxQty) {
                    currentQty++;
                    qtyDisplay.textContent = currentQty;
                }
            };

            qtyContainer.appendChild(qtyLabel);
            qtyContainer.appendChild(minusButton);
            qtyContainer.appendChild(qtyDisplay);
            qtyContainer.appendChild(plusButton);
            productBody.appendChild(qtyContainer);

            const addToCartButton = document.createElement('button');
            addToCartButton.className = 'btn btn-primary w-100';
            addToCartButton.innerHTML = 'Put in Cart <i class="fa-solid fa-cart-shopping"></i>';

            addToCartButton.addEventListener('click', () => {
                const quantity = qtyDisplay.textContent;
                if (parseInt(quantity) > 0) {
                    addToCart(product, quantity);
                    addToCartButton.innerHTML = '<i class="fa fa-spinner" aria-hidden="true"></i>';
                    addToCartButton.disabled = true;
                }
            });

            // Check if item is already in the cart
            if (cartItems[product.id]) {
                addToCartButton.className = 'btn add w-100';
                addToCartButton.innerHTML = '<i class="fa-solid fa-basket-shopping fa-bounce"></i> Already in Cart';
                addToCartButton.disabled = true;
            }

            productBody.appendChild(addToCartButton);
            productCard.appendChild(productBody);
            productCol.appendChild(productCard);
            productRow.appendChild(productCol);
        });

        categoryDiv.appendChild(productRow);
        categoriesContainer.appendChild(categoryDiv);
    }
}

async function addToCart(product, quantity) {
    const cartRef = ref(database, `carts/${currentUserUid}/${product.id}`);
    const cartItem = {
        productName: product.productName,
        finalPrice: product.finalPrice,
        quantity: parseInt(quantity),
        totalPrice: (product.finalPrice * quantity).toFixed(2),
        imageURL: product.imageURL,
        productType: product.productType,
        originalPrice: product.originalPrice,
        qtyUnit: product.qtyUnit,
        availableQuantity: product.quantity
    };

    await set(cartRef, cartItem);
    console.log('Product added to cart:', cartItem);
    // alert(`${product.productName} added to cart!`); // Removed the alert message

    cartItems[product.id] = cartItem; 
    storeCartInLocalStorage(cartItems); 
    renderProducts(allProducts); 
}


function filterProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase() || 
                       document.getElementById('searchInputDesktop').value.toLowerCase();
    const filteredProducts = {};

    for (const category in allProducts) {
        const productsInCategory = allProducts[category].filter(product =>
            product.productName.toLowerCase().includes(searchTerm)
        );

        if (productsInCategory.length > 0) {
            filteredProducts[category] = productsInCategory;
        }
    }

    renderProducts(filteredProducts);
}

document.getElementById('searchInput').addEventListener('input', filterProducts);
document.getElementById('searchInputDesktop').addEventListener('input', filterProducts);

// Prevent form submission when Enter is pressed
document.getElementById('searchForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevents page reload
    filterProducts(); // Call your filter function
});

function showSpinner() {
    document.getElementById('spinner').style.display = 'flex';
}

function hideSpinner() {
    document.getElementById('spinner').style.display = 'none';
}


const cards = document.querySelectorAll('.offer-card');
const dotsContainer = document.querySelector('.dots-container');
let currentIndex = 0;

// Create dots for navigation
cards.forEach((_, index) => {
    const dot = document.createElement('div');
    dot.classList.add('dot');
    dot.addEventListener('click', () => {
        moveToCard(index);
    });
    dotsContainer.appendChild(dot);
});

// Set the first dot as active
dotsContainer.children[currentIndex].classList.add('active');

function moveToCard(index) {
    currentIndex = index;
    const offset = -currentIndex * 100;
    cards.forEach((card, i) => {
        card.style.transform = `translateX(${offset}%)`;
    });
    updateDots();
}

// Update the active dot
function updateDots() {
    Array.from(dotsContainer.children).forEach(dot => dot.classList.remove('active'));
    dotsContainer.children[currentIndex].classList.add('active');
}

// Auto-slide every 2 seconds
setInterval(() => {
    currentIndex = (currentIndex + 1) % cards.length;
    moveToCard(currentIndex);
}, 2000);

// Function to calculate distance
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in km
}

function deg2rad(deg) {
    return deg * (Math.PI / 180);
}

// Function to fetch all user data from Firebase
async function getAllUsersData() {
    const usersRef = ref(database, 'users/');
    const snapshot = await get(usersRef);
    return snapshot.exists() ? snapshot.val() : null;
}

</script>
<script>
    const placeholders = ["Products", "Search for Snacks", "Beverages", "Bakery", "Personal Care"];
let currentIndex = 0;

function changePlaceholder() {
    const searchInput = document.getElementById('searchInput');
    searchInput.placeholder = placeholders[currentIndex];
    currentIndex = (currentIndex + 1) % placeholders.length; // Cycle through the array
}

// Change the placeholder every 2 seconds (2000 ms)
setInterval(changePlaceholder, 2000);

// Set the initial placeholder
changePlaceholder();

function scrollToCategory(category) {
    const categoryElement = document.getElementById(category);
    if (categoryElement) {
        const elementPosition = categoryElement.getBoundingClientRect().top; // Position of the element relative to the viewport
        const offsetPosition = window.scrollY + elementPosition - (window.innerHeight / 2) + (categoryElement.clientHeight / 2); // Calculate the position to scroll to
        
        window.scrollTo({
            top: offsetPosition,
            behavior: 'smooth'
        });
    } else {
        console.error(`Category section "${category}" not found.`);
    }
}


</script>

</body>
</html>
